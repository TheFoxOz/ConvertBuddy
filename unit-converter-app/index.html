<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConvertBuddy Universal Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom Tailwind Configuration and Styles to Match ConvertBuddy Aesthetic */
        :root {
            /* Define a custom primary color based on the design (a friendly teal/green) */
            --color-primary-green: #10b981; /* Emerald-500/600 equivalent */
            --color-bg-mint: #f0fff0;
            --color-text-green: #059669; /* Darker green for text */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-mint);
        }
        .card {
            box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.1), 0 0 20px -5px rgba(0, 0, 0, 0.05);
        }
        select, input[type="number"], input[type="text"] {
            /* Reset browser styles */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-color: #d1d5db; /* Default light gray border */
        }
        
        /* Style for the focus state using the primary green */
        .input-focus-green:focus {
            outline: none;
            border-color: var(--color-primary-green) !important;
            box-shadow: 0 0 0 1px var(--color-primary-green) !important;
            z-index: 10; /* Ensure focus ring is on top of neighbors */
        }
        
        /* FIX: Remove border-left on the unit selects to eliminate double borders */
        .unit-select {
            border-left-width: 0 !important;
        }

        /* Styling the highlighted result field */
        #to-value-wrapper {
            background-color: #ecfdf5; /* Light green background for result */
            border-color: var(--color-primary-green);
            border-width: 1px;
            box-shadow: 0 1px 3px 0 rgba(16, 185, 129, 0.2); /* Subtle green shadow */
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-center min-h-screen">

    <div class="text-center mb-6">
        <h1 class="text-4xl font-extrabold" style="color: var(--color-text-green);">
            ConvertBuddy
        </h1>
        <p class="text-gray-600 mt-2 text-sm max-w-sm">
            Your friendly unit converter with 10 categories, including <span class="font-bold">Live Currencies</span>.
        </p>
    </div>

    <div id="app" class="w-full max-w-lg card bg-white p-6 md:p-8 rounded-xl">
        
        <!-- Category Selector -->
        <div id="category-wrapper" class="w-full relative flex items-center mb-6 rounded-lg border input-focus-green" style="border-color: var(--color-primary-green);">
            <!-- Dynamic Icon (FIX: Retains correct spacing) -->
            <span id="category-icon" class="absolute left-3 text-2xl pr-2 flex items-center" style="color: var(--color-primary-green);">
                <i class="fas fa-money-bill-wave"></i>
            </span>
            <select id="category-select" class="block w-full py-3 pl-12 pr-4 text-lg text-gray-700 bg-transparent rounded-lg cursor-pointer transition duration-150 ease-in-out">
                <!-- Options populated by JS -->
            </select>
            <!-- Dropdown Arrow Icon -->
            <div class="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400">
                <i class="fas fa-chevron-down text-sm"></i>
            </div>
        </div>
        
        <!-- Input Fields Container -->
        <div class="space-y-4">
            <!-- FROM Input Group -->
            <div class="flex flex-col space-y-2">
                <label for="from-value" class="text-sm font-medium text-gray-600">From Value</label>
                <div class="flex">
                    <!-- Value Input -->
                    <input type="number" id="from-value" value="1.0" min="0" class="flex-grow p-3 border rounded-l-lg text-lg text-gray-800 input-focus-green transition duration-150 ease-in-out appearance-none" placeholder="Enter value">
                    <!-- Unit Select -->
                    <select id="from-unit" class="unit-select w-28 md:w-36 p-3 border rounded-r-lg bg-gray-50 text-lg font-semibold text-gray-700 cursor-pointer input-focus-green transition duration-150 ease-in-out">
                        <!-- Options populated by JS -->
                    </select>
                </div>
            </div>

            <!-- Conversion Arrow Button -->
            <div class="flex justify-center my-4">
                <button id="swap-button" class="bg-white text-white p-4 rounded-full shadow-xl transform active:scale-95 transition duration-150 ease-in-out hover:shadow-2xl" aria-label="Swap units" style="background-color: var(--color-primary-green);">
                    <i class="fas fa-arrows-left-right text-lg"></i>
                </button>
            </div>

            <!-- TO Input Group (Output) -->
            <div class="flex flex-col space-y-2">
                <label for="to-value" class="text-sm font-medium text-gray-600">Converted Result</label>
                <!-- FIX: Merged duplicate class attributes and added rounded-lg -->
                <div id="to-value-wrapper" class="flex rounded-lg">
                    <!-- Value Output - Highlighted -->
                    <input type="text" id="to-value" readonly class="flex-grow p-3 text-lg text-gray-800 bg-transparent cursor-not-allowed font-mono border-none focus:ring-0">
                    <!-- Unit Select -->
                    <select id="to-unit" class="unit-select w-28 md:w-36 p-3 border rounded-r-lg bg-gray-50 text-lg font-semibold text-gray-700 cursor-pointer input-focus-green transition duration-150 ease-in-out">
                        <!-- Options populated by JS -->
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Info Footer -->
        <div class="mt-6 pt-4 border-t border-gray-200 text-sm text-center">
            <p id="currency-info" class="text-gray-500 min-h-[1.25rem]">
                <!-- Currency data source info -->
            </p>
            <div id="loading-spinner" class="hidden flex justify-center items-center mt-2">
                <i class="fas fa-spinner fa-spin text-xl" style="color: var(--color-primary-green);"></i>
                <span class="ml-2 font-semibold" style="color: var(--color-primary-green);">Loading live rates...</span>
            </div>
        </div>

        <p class="text-xs text-gray-400 mt-4 text-center">
            All conversions are based on a fixed base unit (USD, Meter, Celsius, etc.).
        </p>
    </div>

    <script type="module">
        // Global variables for Firebase access (required by the environment)
        // Kept for environmental compatibility, though not used for local storage logic
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initialAuthToken : null;
        
        // Constants for Currency API and Local Storage
        const CURRENCY_API_KEY = "b55c79e2ac77eeb4091f0253";
        const CURRENCY_API_BASE_URL = "https://v6.exchangerate-api.com/v6/";
        const CURRENCY_STORAGE_KEY = "universalConverterRates";

        // Global State Variables
        const el = {};
        let currencyRates = {}; 
        let currentCategory = "Currency";

        // FIX: Expanded list of currency symbols
        const currencySymbols = {
            USD: "$", EUR: "€", GBP: "£", JPY: "¥", CNY: "¥", INR: "₹",
            KRW: "₩", CHF: "Fr", AUD: "$", CAD: "$", NZD: "$", RUB: "₽",
            MXN: "$", SGD: "$", HKD: "$", BRL: "R$", IDR: "Rp", ZAR: "R"
        };
        
        let conversionData = {
            Currency: {
                icon: 'fas fa-money-bill-wave',
                units: {} 
            },
            Length: {
                icon: 'fas fa-ruler',
                units: {
                    Meter: { symbol: "m", toBase: 1 },
                    Kilometer: { symbol: "km", toBase: 1000 },
                    Centimeter: { symbol: "cm", toBase: 0.01 },
                    Millimeter: { symbol: "mm", toBase: 0.001 },
                    Mile: { symbol: "mi", toBase: 1609.34 },
                    Yard: { symbol: "yd", toBase: 0.9144 },
                    Foot: { symbol: "ft", toBase: 0.3048 },
                    Inch: { symbol: "in", toBase: 0.0254 }
                }
            },
            Weight: {
                icon: 'fas fa-weight-hanging',
                units: {
                    Kilogram: { symbol: "kg", toBase: 1 },
                    Gram: { symbol: "g", toBase: 0.001 },
                    Milligram: { symbol: "mg", toBase: 0.000001 },
                    Tonne: { symbol: "t", toBase: 1000 },
                    Pound: { symbol: "lb", toBase: 0.453592 },
                    Ounce: { symbol: "oz", toBase: 0.0283495 }
                }
            },
            Temperature: {
                icon: 'fas fa-temperature-half',
                units: {
                    // Temperature conversion functions (base = Celsius)
                    Celsius:   { symbol: "°C", toBase: v => v,               fromBase: v => v },
                    Fahrenheit:{ symbol: "°F", toBase: v => (v - 32) * 5/9,  fromBase: v => v * 9/5 + 32 },
                    Kelvin:    { symbol: "K",  toBase: v => v - 273.15,      fromBase: v => v + 273.15 }
                }
            },
            Volume: {
                icon: 'fas fa-glass-whiskey',
                units: {
                    Liter: { symbol: "L", toBase: 0.001 }, // Base: CubicMeter
                    Milliliter: { symbol: "mL", toBase: 0.000001 },
                    CubicMeter: { symbol: "m³", toBase: 1 },
                    Gallon: { symbol: "gal", toBase: 0.00378541 },
                    Quart: { symbol: "qt", toBase: 0.000946353 },
                    Cup: { symbol: "cup", toBase: 0.000236588 },
                    Tablespoon: { symbol: "tbsp", toBase: 0.0000147868 },
                    Teaspoon: { symbol: "tsp", toBase: 0.00000492892 }
                }
            },
            Area: {
                icon: 'fas fa-vector-square',
                units: {
                    SquareMeter: { symbol: "m²", toBase: 1 },
                    SquareKilometer: { symbol: "km²", toBase: 1_000_000 },
                    SquareFoot: { symbol: "ft²", toBase: 0.092903 },
                    SquareInch: { symbol: "in²", toBase: 0.00064516 },
                    Hectare: { symbol: "ha", toBase: 10_000 },
                    Acre: { symbol: "acre", toBase: 4046.86 }
                }
            },
            Speed: {
                icon: 'fas fa-tachometer-alt',
                units: { // Base: Meter/Second (1)
                    "Meter/Second": { symbol: "m/s", toBase: 1 },
                    "Kilometer/Hour": { symbol: "km/h", toBase: 0.277778 },
                    "Mile/Hour": { symbol: "mph", toBase: 0.44704 },
                    "Foot/Second": { symbol: "ft/s", toBase: 0.3048 }
                }
            },
            Time: {
                icon: 'fas fa-clock',
                units: { // Base: Second (1)
                    Second: { symbol: "s", toBase: 1 },
                    Minute: { symbol: "min", toBase: 60 },
                    Hour: { symbol: "h", toBase: 3600 },
                    Day: { symbol: "d", toBase: 86400 }
                }
            },
            Storage: {
                icon: 'fas fa-database',
                units: { // Base: Byte (1)
                    Byte: { symbol: "B", toBase: 1 },
                    Kilobyte: { symbol: "KB", toBase: 1024 },
                    Megabyte: { symbol: "MB", toBase: 1024**2 },
                    Gigabyte: { symbol: "GB", toBase: 1024**3 },
                    Terabyte: { symbol: "TB", toBase: 1024**4 }
                }
            },
            Energy: {
                icon: 'fas fa-bolt',
                units: { // Base: Joule (1)
                    Joule: { symbol: "J", toBase: 1 },
                    Kilojoule: { symbol: "kJ", toBase: 1000 },
                    Calorie: { symbol: "cal", toBase: 4.184 },
                    Kilocalorie: { symbol: "kcal", toBase: 4184 },
                    WattHour: { symbol: "Wh", toBase: 3600 },
                    KilowattHour: { symbol: "kWh", toBase: 3_600_000 }
                }
            }
        };

        /**
         * Selects all necessary DOM elements and stores them in the global 'el' object.
         */
        function initializeElements() {
            el.categorySelect = document.getElementById('category-select');
            el.categoryIcon = document.getElementById('category-icon');
            el.fromValue = document.getElementById('from-value');
            el.fromUnit = document.getElementById('from-unit');
            el.toValue = document.getElementById('to-value');
            el.toUnit = document.getElementById('to-unit');
            el.swapButton = document.getElementById('swap-button');
            el.currencyInfo = document.getElementById('currency-info');
            el.loading = document.getElementById('loading-spinner');
            
            // Run DOM manipulation once (Improvement B)
            document.querySelectorAll('.input-focus-green').forEach(element => {
                element.classList.add('p-3', 'border', 'rounded-lg');
            });
            document.getElementById('to-value').classList.remove('rounded-l-lg'); 
        }

        /**
         * Populates the category dropdown and initializes the category state.
         */
        function populateCategories() {
            const categories = Object.keys(conversionData);
            el.categorySelect.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            currentCategory = el.categorySelect.value;
            updateCategoryIcon();
        }

        /**
         * Updates the icon next to the category dropdown.
         */
        function updateCategoryIcon() {
            const iconClass = conversionData[currentCategory].icon;
            el.categoryIcon.innerHTML = `<i class="${iconClass}"></i>`;
        }

        /**
         * Populates the 'from' and 'to' unit dropdowns based on the current category.
         */
        function populateUnits() {
            const units = conversionData[currentCategory].units;
            const unitNames = Object.keys(units);
            
            const options = unitNames.map(name => {
                const symbol = units[name].symbol ? ` (${units[name].symbol})` : '';
                return `<option value="${name}">${name}${symbol}</option>`;
            }).join('');
            
            el.fromUnit.innerHTML = options;
            el.toUnit.innerHTML = options;

            // Set default selected units, ensuring they are different if possible
            el.fromUnit.value = unitNames[0];
            el.toUnit.value = unitNames.length > 1 ? unitNames[1] : unitNames[0];

            convertValue();
        }

        // ⭐ 5. IMPROVED convertValue() FIXED VERSION
        function convertValue() {
            const category = conversionData[currentCategory];
            const fromUnit = el.fromUnit.value;
            const toUnit = el.toUnit.value;
            const input = parseFloat(el.fromValue.value);

            if (isNaN(input)) {
                el.toValue.value = "Invalid Input";
                return;
            }

            const from = category.units[fromUnit];
            const to = category.units[toUnit];

            let converted;

            if (currentCategory === "Temperature") {
                // To Base (Celsius) -> From Base (Target)
                converted = to.fromBase(from.toBase(input));
            } else {
                // Standard linear conversion
                converted = input * from.toBase / to.toBase;
            }

            // FIX: Uses toPrecision(12) for high accuracy, then toString() to remove scientific notation if possible
            const formatted =
                currentCategory === "Temperature"
                    ? converted.toFixed(2)
                    : Number(converted.toPrecision(12)).toString();

            // FIX: Symbol logic applied to ALL categories, showing symbol + space if available (Bug 3 fixed)
            const symbol = to.symbol ? `${to.symbol} ` : ""; 

            el.toValue.value = `${symbol}${formatted}`;
        }


        /**
         * Swaps the 'from' and 'to' units and re-runs the conversion.
         */
        function swapUnits() {
            // Swap units
            const tempUnit = el.fromUnit.value;
            el.fromUnit.value = el.toUnit.value;
            el.toUnit.value = tempUnit;
            
            // FIX: Extract numeric value only for swap to prevent corruption (Bug 2 fixed)
            const numericToVal = parseFloat(el.toValue.value.replace(/[^\d.-]/g, ""));
            el.fromValue.value = isNaN(numericToVal) ? "" : numericToVal;
            
            convertValue();
        }

        /**
         * Fetches live currency rates from Exchangerate-API v6.
         */
        async function fetchCurrencyRates() {
            el.loading.classList.remove("hidden");

            const storedRates = localStorage.getItem(CURRENCY_STORAGE_KEY);
            let ratesSource = "Offline cached rates.";

            if (storedRates) {
                try {
                    currencyRates = JSON.parse(storedRates);
                } catch (e) {
                    console.error("Error parsing cached rates.", e);
                }
            }

            // OPTIMIZED: Shorter exponential backoff (500ms -> 1s -> 2s)
            const maxRetries = 3;
            let currentRetry = 0;
            let success = false;

            while (currentRetry < maxRetries && !success) {
                try {
                    const response = await fetch(
                        `${CURRENCY_API_BASE_URL}${CURRENCY_API_KEY}/latest/USD`
                    );

                    const data = await response.json();

                    if (data.result === "success" && data.conversion_rates) {
                        currencyRates = data.conversion_rates;
                        localStorage.setItem(CURRENCY_STORAGE_KEY, JSON.stringify(currencyRates));
                        ratesSource = `Live data (Updated: ${data.time_last_update_utc.split(' ').slice(0, 4).join(' ')})`;
                        success = true;
                    } else {
                        console.error("API error:", data);
                        break; 
                    }
                } catch (err) {
                    currentRetry++;
                    if (currentRetry < maxRetries) {
                        // 500ms, 1000ms, 2000ms
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, currentRetry - 1) * 500));
                    } else {
                        console.warn("Currency API failed after multiple retries. Using cached data.", err);
                    }
                }
            }
            
            if (!success && storedRates) { ratesSource = "API failed — using cached data."; }
            
            // Build Currency Units (if rates exist)
            if (Object.keys(currencyRates).length > 0) {
                conversionData.Currency.units = Object.fromEntries(
                    Object.entries(currencyRates).map(([code, rate]) => {
                        // FIX: Use centralized currencySymbols map
                        const symbol = currencySymbols[code] ?? code;

                        return [
                            code,
                            {
                                name: code,
                                // toBase: 1 unit = X USD
                                toBase: 1 / rate, 
                                symbol: symbol
                            }
                        ];
                    })
                );
            }
            
            el.currencyInfo.textContent = ratesSource;
            el.loading.classList.add("hidden");

            if (currentCategory === 'Currency') {
                populateUnits();
            }
        }


        /**
         * Handles initialization and event listeners after the DOM is loaded.
         */
        window.onload = async () => {
            initializeElements();
            populateCategories();
            
            // 1. Fetch currency rates and populate the 'Currency' units
            await fetchCurrencyRates();

            // 2. Set event listeners
            el.categorySelect.addEventListener('change', () => {
                currentCategory = el.categorySelect.value;
                updateCategoryIcon();
                populateUnits(); // calls convertValue() internally
            });

            el.fromValue.addEventListener('input', convertValue);
            el.fromUnit.addEventListener('change', convertValue);
            el.toUnit.addEventListener('change', convertValue);

            el.swapButton.addEventListener('click', swapUnits);

            // Initial population of units for the default category (Currency)
            populateUnits(); 
        };
    </script>
</body>
</html>
