<!DOCTYPE html>
<html lang="fr">
<head>
Â Â Â  <meta charset="UTF-8">
Â Â Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â Â Â  <title>ConvertBuddy â€“ Convertisseur d'UnitÃ©s Universel</title>
Â Â Â  
Â Â Â  <!-- Vercel Analytics Script Installation (Added) -->
Â Â Â  <script src="/_vercel/insights/script.js"></script>
Â 
Â Â Â  <!-- PWA Essentials (Links corrected to root scope) -->
Â Â Â  <link rel="manifest" href="/manifest.json">
Â Â Â  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
Â Â Â  <meta name="theme-color" content="#10b981">
Â Â Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â Â Â  <meta name="apple-mobile-web-app-status-bar-style" content="default">
Â Â Â  <meta name="apple-mobile-web-app-title" content="ConvertBuddy">
Â Â Â  <meta name="application-name" content="ConvertBuddy">
Â Â Â  
Â Â Â  <script src="https://cdn.tailwindcss.com"></script>
Â Â Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
Â Â Â  
Â Â Â  <!-- Google AdSense Main Script: YOUR PUBLISHER ID IS CORRECTLY INSERTED BELOW -->
Â Â Â  <script
Â Â Â  async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9771422699626133"
Â Â Â Â Â  crossorigin="anonymous"></script>
Â 
Â Â Â  <style>
Â Â Â Â Â Â Â  body { 
Â Â Â Â Â Â Â Â Â Â Â  font-family: 'Inter', sans-serif; 
Â Â Â Â Â Â Â Â Â Â Â  background: linear-gradient(to bottom, #f0fdf4, #dcfce7); 
Â Â Â Â Â Â Â Â Â Â Â  min-height: 100vh; 
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  * { -webkit-tap-highlight-color: transparent; }
Â Â Â Â Â Â Â  .converter-card { 
Â Â Â Â Â Â Â Â Â Â Â  background: white; 
Â Â Â Â Â Â Â Â Â Â Â  border-radius: 1.5rem; 
Â Â Â Â Â Â Â Â Â Â Â  box-shadow: 0 20px 40px rgba(16, 185, 129, 0.15); 
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  .btn-swap { 
Â Â Â Â Â Â Â Â Â Â Â  background: #10b981; 
Â Â Â Â Â Â Â Â Â Â Â  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.5);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  .btn-swap:hover { 
Â Â Â Â Â Â Â Â Â Â Â  background: #059669; 
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  select, input { 
Â Â Â Â Â Â Â Â Â Â Â  border: 2px solid #86efac; 
Â Â Â Â Â Â Â Â Â Â Â  transition: border-color 0.2s;
Â Â Â Â Â Â Â Â Â Â Â  /* Ensure inputs and selects have rounded corners */
Â Â Â Â Â Â Â Â Â Â Â  border-radius: 0.75rem; 
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  select:focus, input:focus { 
Â Â Â Â Â Â Â Â Â Â Â  border-color: #10b981; 
Â Â Â Â Â Â Â Â Â Â Â  outline: none; 
Â Â Â Â Â Â Â Â Â Â Â  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  #outputValue {
Â Â Â Â Â Â Â Â Â Â Â  background: #ecfdf5; 
Â Â Â Â Â Â Â Â Â Â Â  color: #065f46; 
Â Â Â Â Â Â Â Â Â Â Â  border: 2px solid #34d399;
Â Â Â Â Â Â Â Â Â Â Â  border-radius: 0.75rem; 
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  .history-entry {
Â Â Â Â Â Â Â Â Â Â Â  cursor: pointer;
Â Â Â Â Â Â Â  }
Â Â Â  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
Â 
Â Â Â  <!-- AD 1: Desktop/Tablet Top Banner (Hidden on small screens) -->
Â Â Â  <!-- !!! IMPORTANT: REPLACE '1234567890' with your actual Desktop Ad Slot ID !!! -->
Â Â Â  <div class="w-full max-w-lg mb-4 hidden sm:block">
Â Â Â Â Â Â Â  <ins class="adsbygoogle"
Â Â Â Â Â Â Â  style="display:block" 
Â Â Â Â Â Â Â  data-ad-client="ca-pub-9771422699626133"
Â Â Â Â Â Â Â  data-ad-slot="1234567890" 
Â Â Â Â Â Â Â  data-ad-format="auto" 
Â Â Â Â Â Â Â  data-full-width-responsive="true"></ins>
Â Â Â Â Â Â Â  <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
Â Â Â  </div>
Â Â Â  
Â Â Â  <!-- AD 2: Mobile Top Banner (Hidden on desktop) -->
Â Â Â  <!-- !!! IMPORTANT: REPLACE '1122334455' with your actual Mobile Ad Slot ID !!! -->
Â Â Â  <div class="w-full max-w-lg mb-4 sm:hidden">
Â Â Â Â Â Â Â  <ins class="adsbygoogle"
Â Â Â Â Â Â Â  style="display:block" 
Â Â Â Â Â Â Â  data-ad-client="ca-pub-9771422699626133"
Â Â Â Â Â Â Â  data-ad-slot="1122334455" 
Â Â Â Â Â Â Â  data-ad-format="auto" 
Â Â Â Â Â Â Â  data-full-width-responsive="true"></ins>
Â Â Â Â Â Â Â  <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
Â Â Â  </div>
Â 
Â Â Â  <div id="app" class="converter-card w-full max-w-lg p-8 space-y-6">
Â Â Â Â Â Â Â  <h1 class="text-4xl font-bold text-center bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent">
Â Â Â Â Â Â Â Â Â Â Â  ConvertBuddy
Â Â Â Â Â Â Â  </h1>
Â Â Â Â Â Â Â  <p class="text-center text-gray-600">Votre convertisseur hors ligne amical â€” Longueur, Poids, TempÃ©rature, Vitesse, Volume, Aire, et **Devises**.</p>
Â 
Â Â Â Â Â Â Â  <!-- Category -->
Â Â Â Â Â Â Â  <div>
Â Â Â Â Â Â Â Â Â Â Â  <label class="block text-sm font-semibold text-gray-700 mb-2">CatÃ©gorie</label>
Â Â Â Â Â Â Â Â Â Â Â  <select id="category" onchange="loadUnits()" class="w-full p-4 text-lg focus:ring-emerald-500"></select>
Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â  <!-- Input -->
Â Â Â Â Â Â Â  <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
Â Â Â Â Â Â Â Â Â Â Â  <div class="md:col-span-3">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <label class="block text-sm font-semibold text-gray-700 mb-1">Valeur</label>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <input
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  type="number" 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  id="inputValue" 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  value="1" 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  min="0" 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  oninput="convert()" 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  class="w-full p-4 text-lg focus:ring-emerald-500" 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  placeholder="Entrez la valeur"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  >
Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â  <div class="md:col-span-2">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <label class="block text-sm font-semibold text-gray-700 mb-1">De</label>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <select id="fromUnit" onchange="convert()" class="w-full p-4 text-lg focus:ring-emerald-500"></select>
Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â  <!-- Swap Button -->
Â Â Â Â Â Â Â  <div class="flex justify-center">
Â Â Â Â Â Â Â Â Â Â Â  <button onclick="swapUnits()" class="p-4 rounded-full btn-swap text-white shadow-lg hover:shadow-xl transition transform hover:scale-105" aria-label="Ã‰changer les unitÃ©s">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <!-- Dedicated Swap Icon -->
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </svg>
Â Â Â Â Â Â Â Â Â Â Â  </button>
Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â  <!-- Output -->
Â Â Â Â Â Â Â  <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
Â Â Â Â Â Â Â Â Â Â Â  <div class="md:col-span-3">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <label class="block text-sm font-semibold text-gray-700 mb-1">RÃ©sultat</label>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <output 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  id="outputValue" 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  class="block w-full p-4 text-2xl font-bold min-h-[68px] flex items-center"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ></output>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <p id="currency-source-info" class="text-xs text-gray-500 mt-1 hidden"></p>
Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â  <div class="md:col-span-2">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <label class="block text-sm font-semibold text-gray-700 mb-1">Ã€</label>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <select id="toUnit" onchange="convert()" class="w-full p-4 text-lg focus:ring-emerald-500"></select>
Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â  <div id="error-message" class="text-red-500 text-center h-6"></div>
Â Â Â Â Â Â Â  <div id="loading-indicator" class="text-center h-6 text-emerald-600 hidden">
Â Â Â Â Â Â Â Â Â Â Â  Chargement des taux...
Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  <div id="firebase-status" class="text-center text-xs text-gray-400">Initialisation...</div>
Â 
Â Â Â Â Â Â Â  <!-- AD 3: Bottom Rectangle Ad (Shown on both) -->
Â Â Â Â Â Â Â  <!-- !!! IMPORTANT: REPLACE '9876543210' with your actual Bottom Ad Slot ID !!! -->
Â Â Â Â Â Â Â  <div class="my-6 text-center">
Â Â Â Â Â Â Â Â Â Â Â  <ins class="adsbygoogle"
Â Â Â Â Â Â Â Â Â Â Â  style="display:block" 
Â Â Â Â Â Â Â Â Â Â Â  data-ad-client="ca-pub-9771422699626133"
Â Â Â Â Â Â Â Â Â Â Â  data-ad-slot="9876543210" 
Â Â Â Â Â Â Â Â Â Â Â  data-ad-format="auto" 
Â Â Â Â Â Â Â Â Â Â Â  data-full-width-responsive="true"></ins>
Â Â Â Â Â Â Â Â Â Â Â  <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
Â Â Â Â Â Â Â  </div>
Â 
Â Â Â Â Â Â Â  <!-- History -->
Â Â Â Â Â Â Â  <div class="border-t pt-6 border-gray-100">
Â Â Â Â Â Â Â Â Â Â Â  <div class="flex justify-between items-center mb-3">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <h2 class="text-xl font-bold text-gray-800">Conversions RÃ©centes</h2>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button onclick="clearHistory()" class="text-sm text-red-600 hover:text-red-800 transition">Effacer tout</button>
Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â  <ul id="historyList" class="space-y-2 max-h-48 overflow-y-auto text-sm">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <li class="text-gray-400 italic">Chargement de l'historique...</li>
Â Â Â Â Â Â Â Â Â Â Â  </ul>
Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  <!-- Footer with Legal Links (New Addition) -->
Â Â Â Â Â Â Â  <footer class="mt-6 pt-4 border-t border-gray-100 text-center text-xs text-gray-500">
Â Â Â Â Â Â Â Â Â Â Â  &copy; 2025 ConvertBuddy. Tous droits rÃ©servÃ©s. | 
Â Â Â Â Â Â Â Â Â Â Â  <a href="privacy.html" class="text-emerald-600 hover:text-emerald-700 font-medium">Politique de ConfidentialitÃ©</a>
Â Â Â Â Â Â Â  </footer>
Â Â Â  </div>
Â 
Â Â Â  <script type="module">
Â Â Â Â Â Â Â  // FIREBASE IMPORTS
Â Â Â Â Â Â Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â Â Â Â Â Â Â  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â Â Â Â Â Â Â  import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, deleteDoc, writeBatch, where, getDocs, limit, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  // GLOBAL CONFIGURATION
Â Â Â Â Â Â Â  setLogLevel('Debug');
Â Â Â Â Â Â Â  const API_URL = 'https://api.exchangerate-api.com/v4/latest/USD';
Â Â Â Â Â Â Â  let currencyRates = null; 
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  // FIREBASE VARIABLES (Initialized below)
Â Â Â Â Â Â Â  let db = null;
Â Â Â Â Â Â Â  let auth = null;
Â Â Â Â Â Â Â  let userId = null;
Â Â Â Â Â Â Â  let isAuthReady = false;
Â Â Â Â Â Â Â  const el = {};
Â 
Â Â Â Â Â Â Â  const unitData = {
Â Â Â Â Â Â Â Â Â Â Â  length: {name:"Longueur",icon:"ðŸ“",baseUnit:"meter",units:{meter:{label:"MÃ¨tre (m)",factor:1},kilometer:{label:"KilomÃ¨tre (km)",factor:1000},mile:{label:"Mile (mi)",factor:1609.34},foot:{label:"Pied (ft)",factor:0.3048},centimeter:{label:"CentimÃ¨tre (cm)",factor:0.01},inch:{label:"Pouce (in)",factor:0.0254}}},
Â Â Â Â Â Â Â Â Â Â Â  volume: {name:"Volume",icon:"ðŸ§ª",baseUnit:"liter",units:{liter:{label:"Litre (L)",factor:1},dl:{label:"DÃ©cilitre (dl)",factor:0.1},cl:{label:"Centilitre (cl)",factor:0.01},ml:{label:"Millilitre (ml)",factor:0.001},cup:{label:"Tasse (US)",factor:0.236588},floz:{label:"Once liquide (fl oz)",factor:0.0295735},teaspoon:{label:"CuillÃ¨re Ã  cafÃ© (tsp)",factor:0.00492892},tablespoon:{label:"CuillÃ¨re Ã  soupe (Tbsp)",factor:0.0147868}}},
Â Â Â Â Â Â Â Â Â Â Â  mass: {name:"Masse",icon:"âš–ï¸",baseUnit:"kilogram",units:{kilogram:{label:"Kilogramme (kg)",factor:1},stone:{label:"Stone (st)",factor:6.35029},pound:{label:"Livre (lb)",factor:0.453592},gram:{label:"Gramme (g)",factor:0.001},ounce:{label:"Once (oz)",factor:0.0283495}}},
Â Â Â Â Â Â Â Â Â Â Â  temperature: {name:"TempÃ©rature",icon:"ðŸŒ¡ï¸",baseUnit:"celsius",conversionType:"temperature",units:{celsius:{label:"Celsius (Â°C)",toBase:v=>v,fromBase:v=>v},fahrenheit:{label:"Fahrenheit (Â°F)",toBase:v=>(v-32)*5/9,fromBase:v=>v*9/5+32},kelvin:{label:"Kelvin (K)",toBase:v=>v-273.15,fromBase:v=>v+273.15}}},
Â Â Â Â Â Â Â Â Â Â Â  speed: {name:"Vitesse",icon:"ðŸŽï¸",baseUnit:"mps",units:{mps:{label:"MÃ¨tre/Seconde (m/s)",factor:1},kph:{label:"KilomÃ¨tre/Heure (km/h)",factor:1/3.6},mph:{label:"Mile/Heure (mph)",factor:0.44704},knots:{label:"NÅ“ud (kn)",factor:0.514444}}},
Â Â Â Â Â Â Â Â Â Â Â  area: {name:"Aire",icon:"ðŸ–¼ï¸",baseUnit:"sq_meter",units:{sq_meter:{label:"MÃ¨tre CarrÃ© (mÂ²)",factor:1},sq_foot:{label:"Pied CarrÃ© (ftÂ²)",factor:0.092903},sq_mile:{label:"Mile CarrÃ© (miÂ²)",factor:2589988.11},hectare:{label:"Hectare (ha)",factor:10000},acre:{label:"Acre (ac)",factor:4046.86}}},
Â Â Â Â Â Â Â Â Â Â Â  currency: {name:"Devise",icon:"ðŸ’µ",baseUnit:"USD",conversionType:"currency",units:
Â Â Â Â Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  USD: { label: "US Dollar ($)", factor: 1 }, EUR: { label: "Euro (â‚¬)", factor: 1 }, GBP: { label: "Livre Sterling (Â£)", factor: 1 },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  CAD: { label: "Dollar Canadien ($)", factor: 1 }, AUD: { label: "Dollar Australien ($)", factor: 1 }, JPY: { label: "Yen Japonais (Â¥)", factor: 1 },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  CHF: { label: "Franc Suisse (Fr)", factor: 1 }, INR: { label: "Roupie Indienne (â‚¹)", factor: 1 }, ZAR: { label: "Rand Sud-Africain (R)", factor: 1 }
Â Â Â Â Â Â Â Â Â Â Â  }}
Â Â Â Â Â Â Â  };
Â 
Â Â Â Â Â Â Â  function fmt(n) { 
Â Â Â Â Â Â Â Â Â Â Â  if (!isFinite(n)) return 'Erreur';
Â Â Â Â Â Â Â Â Â Â Â  return new Intl.NumberFormat('fr-FR',{maximumFractionDigits:6, useGrouping: true}).format(n); 
Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â  // --- FIREBASE UTILITIES ---
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  // Get the correct history collection path
Â Â Â Â Â Â Â  function getHistoryCollectionRef() {
Â Â Â Â Â Â Â Â Â Â Â  if (!db || !userId) return null;
Â Â Â Â Â Â Â Â Â Â Â  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
Â Â Â Â Â Â Â Â Â Â Â  // Private data path for conversion history
Â Â Â Â Â Â Â Â Â Â Â  return collection(db, `artifacts/${appId}/users/${userId}/conversion_history`);
Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â  // Real-time listener for history
Â Â Â Â Â Â Â  function loadHistory() {
Â Â Â Â Â Â Â Â Â Â Â  if (!isAuthReady || !userId) return;
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  const historyColRef = getHistoryCollectionRef();
Â Â Â Â Â Â Â Â Â Â Â  if (!historyColRef) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.error("Firestore not ready for history loading.");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return;
Â Â Â Â Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â Â Â Â Â  // Query to get the 10 most recent entries (by timestamp, descending)
Â Â Â Â Â Â Â Â Â Â Â  const q = query(historyColRef, orderBy("timestamp", "desc"), limit(10));
Â 
Â Â Â Â Â Â Â Â Â Â Â  onSnapshot(q, (snapshot) => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const history = snapshot.docs.map(doc => ({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  id: doc.id,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ...doc.data()
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }));
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  renderHistory(history);
Â Â Â Â Â Â Â Â Â Â Â  }, (error) => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.error("Error listening to history:", error);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.historyList.innerHTML = '<li class="text-red-500 italic">Erreur de chargement de l\'historique.</li>';
Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  // Saves a new conversion to Firestore
Â Â Â Â Â Â Â  async function addHistory(result, fromLabel, toLabel, val) {
Â Â Â Â Â Â Â Â Â Â Â  if (!isFinite(result) || !isAuthReady || !userId) return;
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  const historyColRef = getHistoryCollectionRef();
Â Â Â Â Â Â Â Â Â Â Â  if (!historyColRef) return;
Â 
Â Â Â Â Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await setDoc(doc(historyColRef), {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  val: fmt(val),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  res: fmt(result),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  from: fromLabel.split(' (')[0], 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  to: toLabel.split(' (')[0], 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  timestamp: Date.now() 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â Â Â Â Â  } catch (e) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.error("Error adding document: ", e);
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â  // Clears the history for the current user
Â Â Â Â Â Â Â  async function clearHistory() { 
Â Â Â Â Â Â Â Â Â Â Â  if (!isAuthReady || !userId) return;
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  const historyColRef = getHistoryCollectionRef();
Â Â Â Â Â Â Â Â Â Â Â  if (!historyColRef) return;
Â 
Â Â Â Â Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Fetch all documents to delete them (Firestore limitations)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const snapshot = await getDocs(historyColRef);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const batch = writeBatch(db);
Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  snapshot.docs.forEach((doc) => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  batch.delete(doc.ref);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  });
Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await batch.commit();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.log("History cleared successfully.");
Â Â Â Â Â Â Â Â Â Â Â  } catch (e) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.error("Error clearing history:", e);
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  // Renders history from Firestore data
Â Â Â Â Â Â Â  function renderHistory(history) {
Â Â Â Â Â Â Â Â Â Â Â  el.historyList.innerHTML = history.length === 0
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ? '<li class="text-gray-400 italic">Aucune conversion rÃ©cente</li>' 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  : history.map(h => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const time = new Date(h.timestamp).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return `<li class="history-entry bg-emerald-50 p-3 rounded-xl flex justify-between items-center hover:bg-emerald-100 transition duration-150">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <span class="truncate pr-2">${h.val} ${h.from} <span class="text-teal-600 font-bold">â†’</span> ${h.res} ${h.to}</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <span class="text-xs text-gray-500 flex-shrink-0">${time}</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </li>`;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }).join('');
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  // --- CORE APP LOGIC (UNCHANGED) ---
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  async function fetchCurrencyRatesWithRetry(retries = 3) {
Â Â Â Â Â Â Â Â Â Â Â  el.loading.classList.remove('hidden');
Â Â Â Â Â Â Â Â Â Â Â  el.currencyInfo.classList.add('hidden');
Â Â Â Â Â Â Â Â Â Â Â  el.err.textContent = '';
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  for (let i = 0; i < retries; i++) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const response = await fetch(API_URL);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const data = await response.json();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (data.rates && data.base === 'USD') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  currencyRates = data.rates;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.loading.classList.add('hidden');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.currencyInfo.textContent = `Taux mis Ã  jour: ${new Date().toLocaleTimeString('fr-FR')}`;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.currencyInfo.classList.remove('hidden');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return true;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.warn(`Attempt ${i + 1} failed. Retrying...`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  el.loading.classList.add('hidden');
Â Â Â Â Â Â Â Â Â Â Â  el.err.textContent = "Ã‰chec du chargement des taux de devise aprÃ¨s plusieurs tentatives.";
Â Â Â Â Â Â Â Â Â Â Â  currencyRates = null;
Â Â Â Â Â Â Â Â Â Â Â  return false;
Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â  async function loadUnits(){
Â Â Â Â Â Â Â Â Â Â Â  const catKey = el.cat.value;
Â Â Â Â Â Â Â Â Â Â Â  const units = unitData[catKey].units;
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  if (catKey === 'currency') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.currencyInfo.classList.remove('hidden');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (!currencyRates) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await fetchCurrencyRatesWithRetry();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.currencyInfo.classList.add('hidden');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.loading.classList.add('hidden');
Â Â Â Â Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â Â Â Â Â  [el.from, el.to].forEach(s=>{
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  s.innerHTML=''; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Object.keys(units).forEach(k=>{ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const o=new Option(units[k].label,k);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  s.add(o); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }); 
Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  if (el.from.options.length > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.to.selectedIndex = el.from.selectedIndex === 0 ? 1 : 0;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  convert();
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  function convert(){
Â Â Â Â Â Â Â Â Â Â Â  el.err.textContent='';
Â Â Â Â Â Â Â Â Â Â Â  const v = parseFloat(el.input.value);
Â Â Â Â Â Â Â Â Â Â Â  const cat = unitData[el.cat.value];
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  if(isNaN(v) || v < 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.output.textContent = '0';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (el.input.value !== '') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.err.textContent='Veuillez entrer une valeur valide.';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return;
Â Â Â Â Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â Â Â Â Â  const fromKey = el.from.value;
Â Â Â Â Â Â Â Â Â Â Â  const toKey = el.to.value;
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  if (!cat || !cat.units[fromKey] || !cat.units[toKey]) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.err.textContent = 'UnitÃ©s de conversion introuvables.';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return;
Â Â Â Â Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â Â Â Â Â  const from = cat.units[fromKey];
Â Â Â Â Â Â Â Â Â Â Â  const to = cat.units[toKey];
Â Â Â Â Â Â Â Â Â Â Â  let result;
Â 
Â Â Â Â Â Â Â Â Â Â Â  if(cat.conversionType==='temperature'){
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  result = to.fromBase(from.toBase(v));
Â Â Â Â Â Â Â Â Â Â Â  } else if (cat.conversionType === 'currency') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (!currencyRates) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.err.textContent = "Les taux de devise ne sont pas disponibles. RÃ©essayez ou changez de catÃ©gorie.";
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.output.textContent = '...';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const valueInBase = v / currencyRates[fromKey];
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  result = valueInBase * currencyRates[toKey];
Â Â Â Â Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  result = (v * from.factor) / to.factor;
Â Â Â Â Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â Â Â Â Â  el.output.textContent = fmt(result);
Â Â Â Â Â Â Â Â Â Â Â  addHistory(result, from.label, to.label, v);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  function swapUnits(){
Â Â Â Â Â Â Â Â Â Â Â  const temp=el.from.value;
Â Â Â Â Â Â Â Â Â Â Â  el.from.value=el.to.value; 
Â Â Â Â Â Â Â Â Â Â Â  el.to.value=temp;
Â Â Â Â Â Â Â Â Â Â Â  convert();
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  // --- INITIALIZATION ---
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  async function initializeFirebase() {
Â Â Â Â Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (!firebaseConfig || !firebaseConfig.projectId) throw new Error("Firebase config is missing.");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const app = initializeApp(firebaseConfig);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  db = getFirestore(app);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  auth = getAuth(app);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.status.textContent = "Authentification en cours...";
Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Authenticate the user
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  onAuthStateChanged(auth, (user) => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (user) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  userId = user.uid;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  isAuthReady = true;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.status.textContent = `ConnectÃ© (ID: ${userId})`;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  loadHistory(); // Start real-time history listener after auth
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // If no user is logged in, use anonymous sign-in or custom token
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (token) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  signInWithCustomToken(auth, token).catch(e => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.error("Custom token sign-in failed:", e);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  signInAnonymously(auth); // Fallback to anonymous
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  signInAnonymously(auth);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  });
Â 
Â Â Â Â Â Â Â Â Â Â Â  } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.error("Firebase initialization failed:", error);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.status.textContent = "Erreur de connexion (Voir console).";
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  document.addEventListener('DOMContentLoaded', async () => {
Â Â Â Â Â Â Â Â Â Â Â  el.cat = document.getElementById('category');
Â Â Â Â Â Â Â Â Â Â Â  el.from = document.getElementById('fromUnit');
Â Â Â Â Â Â Â Â Â Â Â  el.to = document.getElementById('toUnit');
Â Â Â Â Â Â Â Â Â Â Â  el.input = document.getElementById('inputValue');
Â Â Â Â Â Â Â Â Â Â Â  el.output = document.getElementById('outputValue');
Â Â Â Â Â Â Â Â Â Â Â  el.err = document.getElementById('error-message');
Â Â Â Â Â Â Â Â Â Â Â  el.loading = document.getElementById('loading-indicator');
Â Â Â Â Â Â Â Â Â Â Â  el.currencyInfo = document.getElementById('currency-source-info');
Â Â Â Â Â Â Â Â Â Â Â  el.historyList = document.getElementById('historyList');
Â Â Â Â Â Â Â Â Â Â Â  el.status = document.getElementById('firebase-status');
Â 
Â Â Â Â Â Â Â Â Â Â Â  // Populate category select
Â Â Â Â Â Â Â Â Â Â Â  Object.keys(unitData).forEach(k => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const o = document.createElement('option'); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  o.value = k; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  o.text = `${unitData[k].icon} ${unitData[k].name}`;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  el.cat.appendChild(o);
Â Â Â Â Â Â Â Â Â Â Â  });
Â 
Â Â Â Â Â Â Â Â Â Â Â  // Initialize Firebase and load units
Â Â Â Â Â Â Â Â Â Â Â  await initializeFirebase();
Â Â Â Â Â Â Â Â Â Â Â  loadUnits();
Â Â Â Â Â Â Â  });
Â 
Â Â Â Â Â Â Â  if('serviceWorker' in navigator){
Â Â Â Â Â Â Â Â Â Â Â  window.addEventListener('load',()=>{
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  navigator.serviceWorker.register('/sw.js', { scope: '/' })
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  .then(reg => console.log('SW EnregistrÃ©:', reg.scope))
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  .catch(err => console.error('Ã‰chec de l\'enregistrement SW:', err));
Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  }
Â Â Â  </script>
</body>
