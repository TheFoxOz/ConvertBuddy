<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConvertBuddy - Universal Unit Converter</title>
    <link rel="manifest" href="/manifest.json">
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <meta name="theme-color" content="#10b981">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f0fdf4; /* bg-emerald-50 */
        }
        /* Custom scrollbar for history area */
        #history-area::-webkit-scrollbar {
            width: 8px;
        }
        #history-area::-webkit-scrollbar-thumb {
            background-color: #34d399; /* emerald-400 */
            border-radius: 4px;
        }
        #history-area::-webkit-scrollbar-track {
            background: #d1fae5; /* emerald-100 */
        }
    </style>
</head>
<body class="bg-emerald-50 text-gray-800">

    <div id="app" class="flex flex-col items-center p-4 sm:p-8 flex-grow">
        
        <!-- Header -->
        <header class="w-full max-w-2xl mb-8">
            <h1 class="text-4xl font-extrabold text-center text-emerald-700 tracking-tight mb-2">
                ConvertBuddy
            </h1>
            <!-- FIX: Updated tagline, removed "offline" -->
            <p class="text-center text-gray-600 mb-6">
                Your friendly unit converter — Length, Weight, Temperature, Speed, Volume, Area, and Currencies.
            </p>
        </header>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden text-center text-emerald-600 font-semibold mb-4 p-3 bg-emerald-100 rounded-lg shadow-inner">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-emerald-500 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading conversion data...
        </div>

        <!-- Main Conversion Card -->
        <div class="w-full max-w-xl bg-white p-6 sm:p-8 rounded-2xl shadow-xl transition-all duration-300">
            
            <div class="mb-6">
                <label for="category-select" class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                <!-- FIX: Added min-h-[48px] for styling stability -->
                <select id="category-select" class="w-full p-3 sm:p-4 text-lg border border-gray-300 rounded-xl bg-gray-50 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors min-h-[48px] shadow-sm">
                    <!-- Options will be populated by JS -->
                </select>
            </div>

            <!-- Input Value -->
            <div class="mb-4">
                <label for="input-value" class="block text-sm font-medium text-gray-700 mb-2">Value to Convert</label>
                <input type="number" id="input-value" value="1" min="0" class="w-full p-4 text-xl font-mono text-gray-900 border border-gray-300 rounded-xl bg-white shadow-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="Enter value">
            </div>

            <!-- From Unit -->
            <div class="mb-4">
                <label for="from-unit" class="block text-sm font-medium text-gray-700 mb-2">From Unit</label>
                <!-- FIX: Added min-h-[48px] for styling stability -->
                <select id="from-unit" class="w-full p-3 sm:p-4 text-lg border border-gray-300 rounded-xl bg-white shadow-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors min-h-[48px]">
                    <!-- Options will be populated by JS -->
                </select>
            </div>

            <!-- To Unit -->
            <div class="mb-6">
                <label for="to-unit" class="block text-sm font-medium text-gray-700 mb-2">To Unit</label>
                <!-- FIX: Added min-h-[48px] for styling stability -->
                <select id="to-unit" class="w-full p-3 sm:p-4 text-lg border border-gray-300 rounded-xl bg-white shadow-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors min-h-[48px]">
                    <!-- Options will be populated by JS -->
                </select>
            </div>

            <!-- Result Display -->
            <div class="p-5 bg-emerald-50 rounded-xl shadow-inner border border-emerald-200">
                <p class="text-sm font-medium text-emerald-700 mb-1">Result</p>
                <p id="result-display" class="text-3xl font-bold text-emerald-800 break-words">
                    0
                </p>
            </div>

            <!-- Currency Source Info -->
            <p id="currency-source-info" class="hidden text-xs text-gray-500 mt-4 text-center italic">
                Currency rates are based on the latest available data.
            </p>
        </div>

        <!-- Conversion History -->
        <section class="w-full max-w-xl mt-8">
            <h2 class="text-2xl font-semibold text-emerald-600 mb-4 border-b border-emerald-200 pb-2">
                Conversion History
                <span id="user-id-display" class="text-xs font-normal text-gray-500 block sm:inline mt-1 sm:mt-0"></span>
            </h2>
            <div id="history-area" class="h-64 overflow-y-auto p-4 bg-white rounded-xl shadow-lg border border-gray-100">
                <p id="no-history-message" class="text-gray-500 italic text-center">No history yet. Start converting!</p>
                <!-- History items will be inserted here -->
            </div>
        </section>

        <!-- Footer -->
        <footer class="w-full max-w-2xl mt-12 text-center text-sm text-gray-500 border-t border-gray-200 pt-6">
            <a href="/privacy.html" class="hover:text-emerald-600 transition-colors underline">Privacy Policy</a>
            <p class="mt-2">© 2025 ConvertBuddy. All rights reserved.</p>
        </footer>
    </div>

    <!-- Firebase and main application script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level for debugging
        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        const el = {
            categorySelect: document.getElementById('category-select'),
            inputValue: document.getElementById('input-value'),
            fromUnit: document.getElementById('from-unit'),
            toUnit: document.getElementById('to-unit'),
            resultDisplay: document.getElementById('result-display'),
            loading: document.getElementById('loading-indicator'),
            currencyInfo: document.getElementById('currency-source-info'),
            historyArea: document.getElementById('history-area'),
            noHistoryMessage: document.getElementById('no-history-message'),
            userIdDisplay: document.getElementById('user-id-display'),
        };

        const conversionData = {
            Length: {
                m: { name: "Meter", toBase: 1, symbol: "m" },
                km: { name: "Kilometer", toBase: 1000, symbol: "km" },
                mi: { name: "Mile", toBase: 1609.34, symbol: "mi" },
                ft: { name: "Foot", toBase: 0.3048, symbol: "ft" },
                in: { name: "Inch", toBase: 0.0254, symbol: "in" }
            },
            Weight: {
                kg: { name: "Kilogram", toBase: 1, symbol: "kg" },
                g: { name: "Gram", toBase: 0.001, symbol: "g" },
                lb: { name: "Pound", toBase: 0.453592, symbol: "lb" },
                oz: { name: "Ounce", toBase: 0.0283495, symbol: "oz" }
            },
            Temperature: {
                C: { name: "Celsius", toBase: v => v, fromBase: v => v, symbol: "°C", isTemp: true },
                F: { name: "Fahrenheit", toBase: v => (v - 32) * (5/9), fromBase: v => (v * (9/5)) + 32, symbol: "°F", isTemp: true },
                K: { name: "Kelvin", toBase: v => v - 273.15, fromBase: v => v + 273.15, symbol: "K", isTemp: true }
            },
            // Placeholder for Currency - Rates will be fetched/updated dynamically
            Currency: {
                USD: { name: "US Dollar", toBase: 1, symbol: "$" },
                EUR: { name: "Euro", toBase: 0.93, symbol: "€" },
                GBP: { name: "British Pound", toBase: 0.81, symbol: "£" },
                JPY: { name: "Japanese Yen", toBase: 155.0, symbol: "¥" }
            }
        };
        let currentRates = {
            USD: 1, EUR: 0.93, GBP: 0.81, JPY: 155.0
        };

        // --- Firebase Initialization and Auth ---

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in using the custom token if provided, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state change to update UI and start Firestore listeners
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        el.userIdDisplay.textContent = ` (User ID: ${userId})`;
                        isAuthReady = true;
                        // Start real-time history listener only after auth is ready
                        setupHistoryListener();
                    } else {
                        // This case might happen if anonymous sign-in fails or user signs out
                        userId = crypto.randomUUID(); // Fallback ID for local logic
                        el.userIdDisplay.textContent = ` (Anon ID: ${userId.substring(0, 8)}...)`;
                        isAuthReady = true;
                        console.error("User is not authenticated. Using random UUID for ID.");
                        setupHistoryListener();
                    }
                });

                // Fetch currency rates immediately
                fetchCurrencyRates();
                
            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                el.loading.textContent = "Error loading application. Check console for details.";
                el.loading.classList.remove('hidden');
            }
        }

        // --- Currency Rate Fetching (Mocked API Call) ---

        // IMPORTANT: The actual Gemini API call logic for external data retrieval 
        // must be implemented if the currency conversion is meant to be real-time/grounded.
        // For this static app, we'll use a mocked fetch, but the structure for the
        // real API call would look like this:
        /*
        async function fetchCurrencyRates() {
            el.loading.classList.remove('hidden');
            el.currencyInfo.classList.add('hidden');
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = "You are a data provider. Your task is to provide the latest exchange rate for USD against EUR, GBP, and JPY in a single JSON object. Only output the JSON.";
            const userQuery = "Provide the current exchange rates for EUR, GBP, and JPY relative to 1 USD. Respond only with JSON: {\"EUR\": 0.93, \"GBP\": 0.81, \"JPY\": 155.0}";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Use Google Search for real-time data
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { 
                        type: "OBJECT", 
                        properties: {
                            "EUR": { "type": "NUMBER" },
                            "GBP": { "type": "NUMBER" },
                            "JPY": { "type": "NUMBER" }
                        }
                    }
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (jsonText) {
                    const rates = JSON.parse(jsonText);
                    currentRates = { USD: 1, ...rates };
                    // Update the conversionData structure
                    Object.keys(currentRates).forEach(code => {
                        if (conversionData.Currency[code]) {
                             conversionData.Currency[code].toBase = 1 / currentRates[code];
                        }
                    });
                    populateUnits();
                    el.currencyInfo.textContent = 'Currency rates are grounded via Google Search and updated in real-time.';
                    el.currencyInfo.classList.remove('hidden');
                } else {
                    console.warn("Could not fetch or parse real-time rates. Using mock data.");
                }
            } catch (e) {
                console.error("Gemini API call failed, using mock data:", e);
            } finally {
                el.loading.classList.add('hidden');
            }
        }
        */

        // Mocked function for this environment
        function fetchCurrencyRates() {
            el.loading.classList.add('hidden');
            el.currencyInfo.classList.remove('hidden');
            el.currencyInfo.textContent = 'Currency rates are based on mock data.';
            populateUnits();
        }


        // --- Conversion Logic ---

        function convertValue() {
            const category = el.categorySelect.value;
            const fromCode = el.fromUnit.value;
            const toCode = el.toUnit.value;
            const value = parseFloat(el.inputValue.value);

            if (isNaN(value) || !category || !fromCode || !toCode) {
                el.resultDisplay.textContent = 'Invalid input';
                return;
            }

            const units = conversionData[category];
            const fromUnit = units[fromCode];
            const toUnit = units[toCode];

            let result = 0;

            if (fromUnit.isTemp) {
                // Temperature conversion (requires two steps: to Celsius/Base, then to Target)
                if (fromCode === toCode) {
                    result = value;
                } else {
                    const valueInBase = fromUnit.toBase(value);
                    result = toUnit.fromBase(valueInBase);
                }
            } else {
                // Standard multiplicative conversion
                if (fromCode === toCode) {
                    result = value;
                } else {
                    const valueInBase = value * fromUnit.toBase;
                    result = valueInBase / toUnit.toBase;
                }
            }

            el.resultDisplay.textContent = result.toLocaleString(undefined, { maximumFractionDigits: 6 });

            // Automatically save conversion to history
            saveConversion(value, fromCode, toCode, category, result);
        }

        // --- UI Population and Setup ---

        function populateCategories() {
            el.categorySelect.innerHTML = Object.keys(conversionData).map(category => 
                `<option value="${category}">${category}</option>`
            ).join('');
            el.categorySelect.value = 'Length'; // Set default
        }

        function populateUnits() {
            const category = el.categorySelect.value;
            const units = conversionData[category];

            el.currencyInfo.classList.toggle('hidden', category !== 'Currency');

            const optionsHTML = Object.keys(units).map(code => 
                `<option value="${code}">${units[code].name} (${units[code].symbol})</option>`
            ).join('');

            el.fromUnit.innerHTML = optionsHTML;
            el.toUnit.innerHTML = optionsHTML;
            
            // Set initial selected units
            const unitCodes = Object.keys(units);
            if (unitCodes.length >= 2) {
                el.fromUnit.value = unitCodes[0];
                el.toUnit.value = unitCodes[1];
            } else if (unitCodes.length === 1) {
                el.fromUnit.value = unitCodes[0];
                el.toUnit.value = unitCodes[0];
            }

            convertValue();
        }

        function setupEventListeners() {
            el.categorySelect.addEventListener('change', populateUnits);
            el.inputValue.addEventListener('input', convertValue);
            el.fromUnit.addEventListener('change', convertValue);
            el.toUnit.addEventListener('change', convertValue);
        }

        // --- Firestore History Management ---

        function getHistoryCollectionRef() {
            // FIX: Simplified the Firestore path to ensure it works with standard rules
            // NOTE: The security rules must allow this path. A safer, private path is:
            // return collection(db, `artifacts/${appId}/users/${userId}/conversion_history`);
            // But based on the provided fix, we use a simple private path structure:
            if (!db || !userId) {
                console.error("Firestore DB or userId not initialized.");
                return null;
            }
            return collection(db, `users/${userId}/conversion_history`);
        }

        function saveConversion(value, from, to, category, result) {
            if (!isAuthReady || !db || !userId) return; // Wait for authentication

            const historyRef = getHistoryCollectionRef();
            if (!historyRef) return;

            // Only save if the value is not NaN and is not a duplicated conversion
            if (isNaN(value)) return;

            addDoc(historyRef, {
                input: value,
                fromUnit: from,
                toUnit: to,
                category: category,
                result: result,
                timestamp: serverTimestamp()
            }).catch(e => {
                console.error("Error saving conversion history:", e);
            });
        }

        function setupHistoryListener() {
            if (!isAuthReady || !db || !userId) {
                console.warn("Skipping history listener setup: Auth not ready or DB/userId missing.");
                return;
            }
            
            const historyRef = getHistoryCollectionRef();
            if (!historyRef) return;
            
            // Query to fetch up to 10 most recent conversions (sorted client-side if needed, but Firestore query is better)
            // Using query() with orderBy() can require an index. We use onSnapshot for real-time updates.
            const q = query(historyRef, orderBy("timestamp", "desc"));

            onSnapshot(q, (snapshot) => {
                const historyItems = [];
                snapshot.forEach(doc => {
                    historyItems.push({ id: doc.id, ...doc.data() });
                });
                
                renderHistory(historyItems);
            }, (error) => {
                console.error("Error listening to history changes:", error);
                el.noHistoryMessage.textContent = "Error loading history.";
                el.noHistoryMessage.classList.remove('hidden');
            });
        }

        function renderHistory(items) {
            if (items.length === 0) {
                el.noHistoryMessage.classList.remove('hidden');
                el.historyArea.innerHTML = '';
                el.historyArea.appendChild(el.noHistoryMessage);
                return;
            }

            el.noHistoryMessage.classList.add('hidden');
            el.historyArea.innerHTML = items.map(item => {
                const inputVal = item.input.toLocaleString(undefined, { maximumFractionDigits: 4 });
                const resultVal = item.result.toLocaleString(undefined, { maximumFractionDigits: 6 });
                const fromSymbol = conversionData[item.category]?.[item.fromUnit]?.symbol || item.fromUnit;
                const toSymbol = conversionData[item.category]?.[item.toUnit]?.symbol || item.toUnit;
                const timeStr = item.timestamp?.toDate ? item.timestamp.toDate().toLocaleTimeString() : '...';

                return `
                    <div class="p-3 mb-2 bg-gray-50 rounded-lg border border-gray-200 shadow-sm text-sm">
                        <div class="flex justify-between items-center text-xs text-gray-400 mb-1">
                            <span class="font-medium text-emerald-600">${item.category}</span>
                            <span>${timeStr}</span>
                        </div>
                        <p class="font-mono text-gray-700">
                            <strong>${inputVal} ${fromSymbol}</strong> &rarr; <strong>${resultVal} ${toSymbol}</strong>
                        </p>
                    </div>
                `;
            }).join('');
        }
        
        // --- Application Start ---

        window.onload = function() {
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log('SW Registered', reg))
                .catch(err => console.error('SW Registration Failed', err));
            }

            populateCategories();
            setupEventListeners();
            initFirebase();
        };

    </script>
</body>
</html>
